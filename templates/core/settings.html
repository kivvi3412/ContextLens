{% extends 'core/base.html' %}
{% load static %}

{% block title %}Settings - ContextLens{% endblock %}

{% block content %}
    <div class="settings-container">
        <div class="settings-header">
            <h1>Settings</h1>
            <p>Configure your OpenAI API settings and prompt templates</p>
        </div>

        <!-- API Configuration Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>API Configuration</h2>
                <button id="addApiConfigBtn" class="btn btn-primary">Add Configuration</button>
            </div>

            <div class="config-grid" id="apiConfigGrid">
                {% for config in api_configs %}
                    <div class="config-card" data-config-id="{{ config.id }}">
                        <div class="config-header">
                            <h3>{{ config.name }}</h3>
                            <div class="config-actions">
                                <button class="btn btn-secondary btn-sm edit-config-btn">Edit</button>
                                <button class="btn btn-error btn-sm delete-config-btn">Delete</button>
                            </div>
                        </div>
                        <div class="config-details">
                            <div class="detail-item">
                                <span class="label">Model:</span>
                                <span class="value">{{ config.model_name }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Base URL:</span>
                                <span class="value">{{ config.base_url }}</span>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <p>No API configurations found. Add one to get started.</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Analysis Configuration Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>Analysis Configuration</h2>
                <p>Configure word group and sentence analysis thresholds</p>
            </div>

            <div class="config-card" id="analysisConfigCard">
                <div class="config-header">
                    <h3>Text Analysis Settings</h3>
                    <div class="config-actions">
                        <button class="btn btn-secondary btn-sm" id="editAnalysisConfigBtn">Edit</button>
                    </div>
                </div>
                <div class="config-details">
                    <div class="detail-item">
                        <span class="label">Word Group Threshold:</span>
                        <span class="value" id="wordGroupThresholdValue">{{ analysis_config.word_group_threshold }} words or fewer</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Current Logic:</span>
                        <span class="value">≤{{ analysis_config.word_group_threshold }} words = Word/Phrase Analysis, >{{ analysis_config.word_group_threshold }} words = Sentence Analysis</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Translation Templates Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>Translation Templates</h2>
                <button id="addTranslationTemplateBtn" class="btn btn-primary">Add Template</button>
            </div>

            <div class="template-grid" id="translationTemplateGrid">
                {% for template in translation_templates %}
                    <div class="template-card {% if template.is_active %}active{% endif %}"
                         data-template-id="{{ template.id }}">
                        <div class="template-header">
                            <h3>{{ template.name }}</h3>
                            <div class="template-actions">
                                {% if template.is_active %}
                                    <span class="status-badge active">Active</span>
                                {% endif %}
                                <button class="btn btn-secondary btn-sm edit-template-btn">Edit</button>
                                <button class="btn btn-error btn-sm delete-template-btn">Delete</button>
                            </div>
                        </div>
                        <div class="template-details">
                            <div class="detail-item">
                                <span class="label">API Config:</span>
                                <span class="value">{{ template.api_config.name }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Reasoning Effort:</span>
                                <span class="value">{{ template.reasoning_effort|title }}</span>
                            </div>
                            <div class="template-prompt">
                                <div class="prompt-preview">{{ template.prompt_text|truncatewords:20 }}</div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <p>No translation templates found. Add one to get started.</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Word Analysis Templates Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>Word Analysis Templates</h2>
                <button id="addAnalysisTemplateBtn" class="btn btn-primary">Add Template</button>
            </div>

            <div class="template-grid" id="analysisTemplateGrid">
                {% for template in analysis_templates %}
                    <div class="template-card {% if template.is_active %}active{% endif %}"
                         data-template-id="{{ template.id }}">
                        <div class="template-header">
                            <h3>{{ template.name }}</h3>
                            <div class="template-actions">
                                {% if template.is_active %}
                                    <span class="status-badge active">Active</span>
                                {% endif %}
                                <button class="btn btn-secondary btn-sm edit-template-btn">Edit</button>
                                <button class="btn btn-error btn-sm delete-template-btn">Delete</button>
                            </div>
                        </div>
                        <div class="template-details">
                            <div class="detail-item">
                                <span class="label">API Config:</span>
                                <span class="value">{{ template.api_config.name }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Reasoning Effort:</span>
                                <span class="value">{{ template.reasoning_effort|title }}</span>
                            </div>
                            <div class="template-prompt">
                                <div class="prompt-preview">{{ template.prompt_text|truncatewords:20 }}</div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <p>No word analysis templates found. Add one to get started.</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sentence Analysis Templates Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>Sentence Analysis Templates</h2>
                <button id="addSentenceTemplateBtn" class="btn btn-primary">Add Template</button>
            </div>

            <div class="template-grid" id="sentenceTemplateGrid">
                {% for template in sentence_templates %}
                    <div class="template-card {% if template.is_active %}active{% endif %}"
                         data-template-id="{{ template.id }}">
                        <div class="template-header">
                            <h3>{{ template.name }}</h3>
                            <div class="template-actions">
                                {% if template.is_active %}
                                    <span class="status-badge active">Active</span>
                                {% endif %}
                                <button class="btn btn-secondary btn-sm edit-template-btn">Edit</button>
                                <button class="btn btn-error btn-sm delete-template-btn">Delete</button>
                            </div>
                        </div>
                        <div class="template-details">
                            <div class="detail-item">
                                <span class="label">API Config:</span>
                                <span class="value">{{ template.api_config.name }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Reasoning Effort:</span>
                                <span class="value">{{ template.reasoning_effort|title }}</span>
                            </div>
                            <div class="template-prompt">
                                <div class="prompt-preview">{{ template.prompt_text|truncatewords:20 }}</div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <p>No sentence analysis templates found. Add one to get started.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Analysis Configuration Modal -->
    <div id="analysisConfigModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Analysis Configuration</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="analysisConfigForm" class="modal-body">
                <div class="form-group">
                    <label for="wordGroupThreshold">Word Group Threshold</label>
                    <input type="number" id="wordGroupThreshold" name="word_group_threshold" min="1" max="50" required onchange="updateThresholdPreview()">
                    <small class="form-text">Number of words or fewer that will be analyzed as word/phrase (currently {{ analysis_config.word_group_threshold }})</small>
                </div>
                <div class="form-help">
                    <h4>How it works:</h4>
                    <p>When you select text in the input area:</p>
                    <ul>
                        <li>If selection has ≤ <strong id="thresholdPreview">{{ analysis_config.word_group_threshold }}</strong> words: <strong>Word/Phrase Analysis</strong></li>
                        <li>If selection has > <strong id="thresholdPreview2">{{ analysis_config.word_group_threshold }}</strong> words: <strong>Sentence Analysis</strong></li>
                    </ul>
                    <script>
                        function updateThresholdPreview() {
                            const threshold = document.getElementById('wordGroupThreshold').value;
                            document.getElementById('thresholdPreview').textContent = threshold;
                            document.getElementById('thresholdPreview2').textContent = threshold;
                        }
                    </script>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelAnalysisConfigBtn">Cancel</button>
                <button type="submit" class="btn btn-primary" form="analysisConfigForm">Save</button>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div id="apiConfigModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="apiConfigModalTitle">Add API Configuration</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="apiConfigForm" class="modal-body">
                <div class="form-group">
                    <label for="configName">Configuration Name</label>
                    <input type="text" id="configName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" name="api_key" required>
                    <small class="form-text">编辑时留空表示保留现有密钥</small>
                </div>
                <div class="form-group">
                    <label for="baseUrl">Base URL</label>
                    <input type="url" id="baseUrl" name="base_url" value="https://api.openai.com/v1" required>
                </div>
                <div class="form-group">
                    <label for="modelName">Model Name</label>
                    <input type="text" id="modelName" name="model_name" value="gpt-4" required>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelApiConfigBtn">Cancel</button>
                <button type="submit" class="btn btn-primary" form="apiConfigForm">Save</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="templateModalTitle">Add Template</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="templateForm" class="modal-body">
                <div class="form-group">
                    <label for="templateName">Template Name</label>
                    <input type="text" id="templateName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="templateType">Template Type</label>
                    <select id="templateType" name="template_type" required>
                        <option value="">Select type...</option>
                        <option value="translation">Translation</option>
                        <option value="word_analysis">Word Analysis</option>
                        <option value="sentence_analysis">Sentence Analysis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="apiConfigSelect">API Configuration</label>
                    <select id="apiConfigSelect" name="api_config_id" required>
                        <option value="">Select configuration...</option>
                        {% for config in api_configs %}
                            <option value="{{ config.id }}">{{ config.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="reasoningEffort">Reasoning Effort</label>
                    <select id="reasoningEffort" name="reasoning_effort">
                        <option value="minimal">Minimal</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="isActive">
                        <input type="checkbox" id="isActive" name="is_active">
                        Make this the active template
                    </label>
                </div>
                <div class="form-group">
                    <label for="promptText">Prompt Template</label>
                    <textarea id="promptText" name="prompt_text" rows="10" required
                              placeholder="Enter your prompt template. Use {all_input} for full text and {input_select} for selected text."></textarea>
                    <div class="form-help">
                        <p>Available placeholders:</p>
                        <ul>
                            <li><code>{all_input}</code> - The complete input text</li>
                            <li><code>{input_select}</code> - The selected word/phrase</li>
                        </ul>
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelTemplateBtn">Cancel</button>
                <button type="submit" class="btn btn-primary" form="templateForm">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/settings.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/settings.js' %}"></script>
{% endblock %}